#: Title :  nShield as a Service (nSaaS) and nShield Container Option Pack
#: Author : "Caio Abreu Ferreira"
#: Description :  nShield as a Service (nSaaS) and nShield Container Option Pack and no docker
#: Options : 
#: https://www.ncipher.com/products/general-purpose-hsms/nshield-as-a-service
#: https://nshieldsupport.entrust.com/hc/en-us/articles/360009873277-HowTo-Setup-a-Self-Managed-nShield-as-a-Service-environment

####################################################################
#
# Information
#
####################################################################

1 Introduction

The nShield Container Option Pack (nSCOP) provides application developers, in a container-based
environment, the ability to access the cryptographic functionality of an nShield Connect HSM.

The nShield Container Option Pack is installed on top of your existing Security World Software
installation, allowing you to continue using your existing Security World and keys.

2 Software Prerequisites

The nShield Container Option Pack requires nShield Security World Software and Docker to be
installed prior to the use of the nShield Container Option Pack scripts.

Before you can begin using nSCOP you must complete the following steps:

1. Set up the HSM(s). For instructions, see the Installation Guide of your HSM(s).

2. Using its IP address, configure your container host machine as a client of the HSM(s).
The container host machine is the machine on which you will run the nShield hardserver and
application containers.

3. To access and use cryptographic keys from a Security World, load or create a Security World
on the HSM, and map the key management data folder (kmdata) from your container host
machine into the running application containers.

####################################################################
#
# Installation - nShield Container Option Pack (nSCOP)
#
####################################################################

#
# Create nshield-hwsp
#

$ mkdir -p /opt/nscop

$ tar xf nscop-1.1.1.tar -C /opt/nscop

$ mount -o loop SecWorld_Lin64-12.80.4.iso /media/cdrom

$ cd /opt/nscop

$ vi make-nshield-hwsp

    FROM: DEFAULT_FROM="registry.access.redhat.com/ubi7/ubi:latest"
    TO: DEFAULT_FROM="docker.io/library/debian:buster-slim"

# Run make-nshield-hwsp to create the hardserver container.
#
# Makes an nShield hardserver Docker image.
#
$ ./make-nshield-hwsp /media/cdrom

$ docker image ls
REPOSITORY     TAG           IMAGE ID       CREATED          SIZE
nshield-hwsp   12.80.4       f338b0fc3b9e   38 minutes ago   320MB
debian         buster-slim   c2303a498941   10 days ago      69.3MB

#
# Configure nshield-hwsp
#

$ sudo mkdir -p /opt/nscop/config

$ sudo cd /opt/nscop/

$ sudo ./make-nshield-hwsp-config --output /opt/nscop/config1/config 93.93.131.226

Error from AnonymousKnetiHash command: RemoteServerFailed, <us> (nCErrno(ECONNREFUSED): Connection refused)

$ sudo ./make-nshield-hwsp-config --output /opt/nscop/config1/config 213.121.187.217

Error from AnonymousKnetiHash command: RemoteServerFailed, <us> (nCErrno(ECONNREFUSED): Connection refused)