#
# TEORIA
#

# DKEK (Device Key Encryption Key)
#

A tecnologia DKEK consiste na derivação de uma chave de criptografia que
já esta armazenada no token para criptografar e proteger uma chave que 
também esta armazenada no token.

A DKEK precisa ser criada durante a inicalização do eToken e antes da criação
de qualquer tipo de chave seja gerada. Se por acaso o dispositivo foi inicializado
antes do DKEK, nenhuma chave poderá ser exportada.

Existem 03 formas de gerar a chave DKEK
- gerar uma chave DKEK no próprio token;
- importar uma chave DKEK em outro token e importar a mesma;
- importar N chaves DKEK no token e distribuir essa a chave do token para 
  N custodiantes;

# wrap
#
public.key = RSA Public Key/ AES Key
unwrapped.key = chave DES
wrapped.key = E(public.key, unwrapped.key)

# unwrap
#
- private.key = RSA Private Key/ AES Key
- wrapped.key = DES
- unwrapped.key = D(private.key, wrapped.key)

#
# COMANDO
#

# Criando o Security Office (SO)
#
$ pkcs11-tool -vv --module /usr/lib/libeToken.so --slot 0 --init-token --label hsm_mt4
Using slot with ID 0x0
Please enter the new SO PIN:
Please enter the new SO PIN (again):
Token successfully initialized

# Crindo o user PIN (PUK)
#
$ pkcs11-tool -vv --module /usr/lib/libeToken.so --init-pin --login --slot 0
Using slot with ID 0x0
Logging in to "hsm_mt4".
Please enter SO PIN:
Please enter the new PIN:
Please enter the new PIN again:
User PIN successfully initialized


$ sc-lshsm-tool --initialize --so-pin 3537363231383830 --pin 648219 --dkek-shares 1 --label hsm_mt4
Using reader with a card: Identiv uTrust 3512 SAM slot Token [CCID Interface] (55511822601851) 00 00

$ sc-hsm-tool
Using reader with a card: Identiv uTrust 3512 SAM slot Token [CCID Interface] (55511822601851) 00 00
Version              : 3.4
Config options       :
  User PIN reset with SO-PIN enabled
SO-PIN tries left    : 15
User PIN tries left  : 3
DKEK shares          : 1
DKEK import pending, 1 share(s) still missing

$ sc-hsm-tool --import-dkek-share passwd.pbe 
Using reader with a card: Identiv uTrust 3512 SAM slot Token [CCID Interface] (55511822601851) 00 00
Enter password to decrypt DKEK share : 

Deciphering DKEK share, please wait...
DKEK share imported
DKEK shares          : 1
DKEK key check value : 6C809AF3E07A1CE0
asc@caprese:~/share/projects/workspace_scsh$ pkcs11-tool --keypairgen -l --key-type rsa:1024 --id 123
Using slot 1 with a present token (0x4)
Logging in to "mytoken (UserPIN)".
Please enter User PIN: 
Key pair generated:
Private Key Object; RSA 
  label:      Private Key
  ID:         0123
  Usage:      decrypt, sign, unwrap
  Access:     none
Public Key Object; RSA 1024 bits
  label:      Private Key
  ID:         0123
  Usage:      encrypt, verify, wrap
  Access:     none
asc@caprese:~/share/projects/workspace_scsh$ sc-hsm-tool -W wrap.bin --key-reference 1
Using reader with a card: Identiv uTrust 3512 SAM slot Token [CCID Interface] (55511822601851) 00 00
Enter User PIN : 

asc@caprese:~/share/projects/workspace_scsh$ ls -la wrap.bin
-rw-r--r-- 1 asc asc 996 Okt  3 10:54 wrap.bin