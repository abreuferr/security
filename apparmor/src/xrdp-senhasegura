#
# xrdp - xrdp prove o login grafico em computadores remotos utilizando o protocolo RDP.
#
# MT4 GROUP
# Guilherme Hakme
#
# apparmor docker-default ( https://github.com/moby/moby/blob/master/profiles/apparmor/template.go )

#include <tunables/global>

profile xrdp-senhasegura flags=(attach_disconnected, mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/openssl>
  #include <abstractions/user-tmp>

  capability dac_override,
  capability kill,

  deny mount,

  deny /sys/[^f]*/** wlkx,
  deny /sys/f[^s]*/** wlkx,
  deny /sys/firmware/** rwlkx,
  deny /sys/fs/[^c]*/** wlkx,
  deny /sys/fs/c[^g]*/** wlkx,
  deny /sys/fs/cg[^r]*/** wlkx,
  deny /sys/kernel/security/** rwlkx,
  deny @{PROC}/* w, # deny write for all files directly in /proc (not in a subdir)
  deny @{PROC}/kcore rwlkx,
  deny @{PROC}/kmem rwlkx,
  deny @{PROC}/mem rwlkx,
  deny @{PROC}/sys/[^k]** w, # deny /proc/sys except /proc/sys/k* (effectively /proc/sys/kernel)
  deny @{PROC}/sys/kernel/{?,??,[^s][^h][^m]**} w, # deny everything except shm* in /proc/sys/kernel/
  deny @{PROC}/sysrq-trigger rwlkx,
  deny @{PROC}/{[^1-9],[^1-9][^0-9],[^1-9s][^0-9y][^0-9s],[^1-9][^0-9][^0-9][^0-9]*}/** w,

  /etc/host.conf r,
  /etc/hosts r,
  /etc/nsswitch.conf r,
  /etc/resolv.conf r,
  /etc/timezone r,
  /etc/xrdp/certs/server.crt r,
  /etc/xrdp/certs/server.key r,
  /etc/xrdp/km-*.ini r,
  /etc/xrdp/rsakeys.ini r,
  /etc/xrdp/xrdp.ini r,
  /etc/xrdp/xrdp_keyboard.ini rw,
  /run/xrdp/xrdp.pid rw,
  /srv/cache/sessao/[0-9a-f]*.drop w,
  /srv/cache/sessao/[0-9a-f]*.holdon rw,
  /srv/cache/sessao/[0-9a-f]*.input w,
  /srv/cache/sessao/[0-9a-f]*.output rw,
  /sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,
  /usr/local/lib/xrdp/libcommon.so.* mr,
  /usr/local/lib/xrdp/libiso.so.* mr,
  /usr/local/lib/xrdp/libxrdp.so.* mr,
  /usr/local/lib/xrdp/libxrdpneutrinordp.so.* mr,
  /usr/local/sbin/xrdp mr,
  /usr/local/share/xrdp/Arial-15.fv1 r,
  /usr/local/share/xrdp/Arial-24.fv1 r,
  /usr/local/share/xrdp/Arial-30.fv1 r,
  /usr/local/share/xrdp/Arial-40.fv1 r,
  /usr/local/share/xrdp/br_logo.bmp r,
  /usr/local/share/xrdp/cursor0.cur r,
  /usr/local/share/xrdp/cursor1.cur r,
  /usr/local/share/xrdp/senhasegura.bmp r,
  /var/senhasegura/arz/*/*[0-9]*/*[0-9]*/*[0-9]*/*[0-9]* w,
  /var/senhasegura/arz/*[0-9]*/*[0-9]*/*[0-9]*/*[0-9]* w,
  /var/tmp/xrdp/xrdp_*[0-9]*.status w,
  owner /proc/*/cmdline r,
  owner /var/log/xrdp.log w,

}
